


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CarModelServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.rentalcarsystem.reservationservice.services</a>
</div>

<h1>Coverage Summary for Class: CarModelServiceImpl (com.rentalcarsystem.reservationservice.services)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CarModelServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    55,6%
  </span>
  <span class="absValue">
    (15/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    41,1%
  </span>
  <span class="absValue">
    (23/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    54%
  </span>
  <span class="absValue">
    (75/139)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CarModelServiceImpl$$SpringCGLIB$$0</td>
  </tr>
  <tr>
    <td class="name">CarModelServiceImpl$getAllModels$$inlined$body$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    53,6%
  </span>
  <span class="absValue">
    (15/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    41,1%
  </span>
  <span class="absValue">
    (23/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    53,6%
  </span>
  <span class="absValue">
    (75/140)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.rentalcarsystem.reservationservice.services
&nbsp;
&nbsp;import com.rentalcarsystem.reservationservice.dtos.request.CarModelReqDTO
&nbsp;import com.rentalcarsystem.reservationservice.dtos.request.toEntity
&nbsp;import com.rentalcarsystem.reservationservice.dtos.response.*
&nbsp;import com.rentalcarsystem.reservationservice.enums.*
&nbsp;import com.rentalcarsystem.reservationservice.exceptions.FailureException
&nbsp;import com.rentalcarsystem.reservationservice.exceptions.ResponseEnum
&nbsp;import com.rentalcarsystem.reservationservice.filters.CarModelFilter
&nbsp;import com.rentalcarsystem.reservationservice.models.CarFeature
&nbsp;import com.rentalcarsystem.reservationservice.models.CarModel
&nbsp;import com.rentalcarsystem.reservationservice.models.Reservation
&nbsp;import com.rentalcarsystem.reservationservice.models.Vehicle
&nbsp;import com.rentalcarsystem.reservationservice.repositories.CarFeatureRepository
&nbsp;import com.rentalcarsystem.reservationservice.repositories.CarModelRepository
&nbsp;import com.rentalcarsystem.reservationservice.repositories.ReservationRepository
&nbsp;import jakarta.validation.Valid
&nbsp;import org.springframework.beans.factory.annotation.Value
&nbsp;import org.springframework.data.domain.PageRequest
&nbsp;import org.springframework.data.domain.Pageable
&nbsp;import org.springframework.data.domain.Sort
&nbsp;import org.springframework.data.jpa.domain.Specification
&nbsp;import org.springframework.http.MediaType.APPLICATION_JSON
&nbsp;import org.springframework.stereotype.Service
&nbsp;import org.springframework.transaction.annotation.Transactional
&nbsp;import org.springframework.validation.annotation.Validated
&nbsp;import org.springframework.web.client.RestClient
&nbsp;import org.springframework.web.client.body
&nbsp;import java.time.LocalDateTime
&nbsp;
&nbsp;@Service
&nbsp;@Transactional
&nbsp;@Validated
<b class="fc">&nbsp;class CarModelServiceImpl(</b>
<b class="fc">&nbsp;    private val carModelRepository: CarModelRepository,</b>
<b class="fc">&nbsp;    private val carFeatureRepository: CarFeatureRepository,</b>
<b class="fc">&nbsp;    private val reservationRepository: ReservationRepository,</b>
<b class="fc">&nbsp;    private val vehicleService: VehicleService,</b>
<b class="fc">&nbsp;    private val userManagementRestClient: RestClient,</b>
<b class="fc">&nbsp;    @Value(&quot;\${reservation.buffer-days}&quot;)</b>
&nbsp;    private val reservationBufferDays: Long,
&nbsp;) : CarModelService {
<b class="nc">&nbsp;    override fun getAllModels(</b>
&nbsp;        page: Int,
&nbsp;        size: Int,
&nbsp;        singlePage: Boolean,
&nbsp;        sortBy: String,
&nbsp;        sortOrder: String,
&nbsp;        @Valid filters: CarModelFilter,
&nbsp;        desiredPickUpDate: LocalDateTime?,
&nbsp;        desiredDropOffDate: LocalDateTime?,
&nbsp;        customerId: Long?,
&nbsp;        reservationToUpdateId: Long?
&nbsp;    ): PagedResDTO&lt;CarModelResDTO&gt; {
&nbsp;        // TODO: If customerId is provided, validate customerId existence by interacting with UserManagementService
&nbsp;        // TODO: If user is logged in with role != customer AND if customerId is provided, ensure (role of (user with customerId) == customer) else throw 422
&nbsp;        // Validation of reservationToUpdate if provided
<b class="pc">&nbsp;        if (reservationToUpdateId != null) {</b>
<b class="nc">&nbsp;            val reservationToUpdate = reservationRepository.findById(reservationToUpdateId).orElseThrow {</b>
<b class="nc">&nbsp;                FailureException(ResponseEnum.RESERVATION_NOT_FOUND, &quot;Reservation with id $reservationToUpdateId was not found&quot;)</b>
&nbsp;            }
&nbsp;            // TODO: If user is logged in with role == customer, ensure (reservationToUpdate.customerId == logged in user&#39;s id) else throw 403
<b class="nc">&nbsp;            if (reservationToUpdate.customerId != customerId) { // TODO: Add condition: If user is logged in with role != customer &amp;&amp;</b>
<b class="nc">&nbsp;                throw IllegalArgumentException(</b>
<b class="nc">&nbsp;                    &quot;You are not allowed to search for available models with customer id $customerId and reservation $reservationToUpdateId&quot;</b>
&nbsp;                )
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var spec: Specification&lt;CarModel&gt; = Specification.where(null)</b>
&nbsp;        // Brand
<b class="pc">&nbsp;        filters.brand?.takeIf { it.isNotBlank() }?.let { brand -&gt;</b>
<b class="fc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="fc">&nbsp;                cb.like(cb.lower(root.get(&quot;brand&quot;)), &quot;${brand.lowercase()}%&quot;)</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;        // Model
<b class="pc">&nbsp;        filters.model?.takeIf { it.isNotBlank() }?.let { model -&gt;</b>
<b class="nc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="nc">&nbsp;                cb.like(cb.lower(root.get(&quot;model&quot;)), &quot;${model.lowercase()}%&quot;)</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Year
<b class="pc">&nbsp;        filters.year?.let { year -&gt;</b>
<b class="nc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="nc">&nbsp;                cb.equal(root.get&lt;String&gt;(&quot;year&quot;), year.toString())</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Segment
<b class="pc">&nbsp;        filters.segment?.let { segment -&gt;</b>
<b class="nc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="nc">&nbsp;                cb.equal(root.get&lt;CarSegment&gt;(&quot;segment&quot;), segment)</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Category
<b class="fc">&nbsp;        filters.category?.let { category -&gt;</b>
<b class="fc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="fc">&nbsp;                cb.equal(root.get&lt;CarCategory&gt;(&quot;category&quot;), category)</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;        // Engine type
<b class="fc">&nbsp;        filters.engineType?.let { engineType -&gt;</b>
<b class="fc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="fc">&nbsp;                cb.equal(root.get&lt;EngineType&gt;(&quot;engineType&quot;), engineType)</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;        // Transmission type
<b class="pc">&nbsp;        filters.transmissionType?.let { transmissionType -&gt;</b>
<b class="nc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="nc">&nbsp;                cb.equal(root.get&lt;TransmissionType&gt;(&quot;transmissionType&quot;), transmissionType)</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Drivetrain
<b class="pc">&nbsp;        filters.drivetrain?.let { drivetrain -&gt;</b>
<b class="nc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="nc">&nbsp;                cb.equal(root.get&lt;Drivetrain&gt;(&quot;drivetrain&quot;), drivetrain)</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Rental price
<b class="pc">&nbsp;        filters.minRentalPrice?.let { minPrice -&gt;</b>
<b class="nc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="nc">&nbsp;                cb.greaterThanOrEqualTo(root.get(&quot;rentalPrice&quot;), minPrice)</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="pc">&nbsp;        filters.maxRentalPrice?.let { maxPrice -&gt;</b>
<b class="nc">&nbsp;            spec = spec.and { root, _, cb -&gt;</b>
<b class="nc">&nbsp;                cb.lessThanOrEqualTo(root.get(&quot;rentalPrice&quot;), maxPrice)</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Adding the search for desired pickup and drop off dates for a given customer if they are given
<b class="pc">&nbsp;        if (desiredPickUpDate != null &amp;&amp; desiredDropOffDate != null) {</b>
<b class="nc">&nbsp;            spec = spec.and(availabilityInDesiredDatesSpec(desiredPickUpDate, desiredDropOffDate, reservationToUpdateId))</b>
<b class="nc">&nbsp;            if (customerId != null) { // TODO: Replace this condition with: &quot;if (user is logged in with role == customer || customerId != null) {&quot;</b>
&nbsp;                // TODO: Replace &quot;uri(&quot;/{userId}&quot;, customerId)&quot; with
&nbsp;                //  &quot;uri(&quot;/{userId}&quot;, if (user is logged in with role == customer) { logged in user&#39;s id } else customerId)&quot;
<b class="nc">&nbsp;                val userScore = userManagementRestClient.get().uri(&quot;/{userId}&quot;, customerId).accept(</b>
<b class="nc">&nbsp;                    APPLICATION_JSON</b>
<b class="nc">&nbsp;                ).retrieve().body&lt;UserResDTO&gt;()?.eligibilityScore</b>
<b class="nc">&nbsp;                spec = spec.and(availabilityForUserScoreSpec(userScore!!))</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // Sorting
<b class="pc">&nbsp;        val sortOrd: Sort.Direction = if (sortOrder == &quot;asc&quot;) Sort.Direction.ASC else Sort.Direction.DESC</b>
<b class="fc">&nbsp;        val actualSize = if (singlePage) carModelRepository.count().toInt() else size</b>
<b class="fc">&nbsp;        val pageable: Pageable = PageRequest.of(page, actualSize, sortOrd, sortBy)</b>
<b class="fc">&nbsp;        val pageResult = carModelRepository.findAll(spec, pageable)</b>
&nbsp;
<b class="fc">&nbsp;        return PagedResDTO(</b>
<b class="fc">&nbsp;            currentPage = pageResult.number,</b>
<b class="fc">&nbsp;            totalPages = pageResult.totalPages,</b>
<b class="fc">&nbsp;            totalElements = pageResult.totalElements,</b>
<b class="fc">&nbsp;            elementsInPage = pageResult.numberOfElements,</b>
<b class="fc">&nbsp;            content = pageResult.content.map { it.toResDTO() }</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    override fun getCarModelById(id: Long): CarModelResDTO {
<b class="fc">&nbsp;        return getActualCarModelById(id).toResDTO()</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun getAllCarFeatures(): List&lt;CarFeatureResDTO&gt; {
<b class="fc">&nbsp;        return carFeatureRepository.findAll().map { it.toResDTO() }</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun getCarFeatureById(id: Long): CarFeatureResDTO {
<b class="fc">&nbsp;        return carFeatureRepository.findById(id).map { it.toResDTO() }</b>
<b class="fc">&nbsp;            .orElseThrow {</b>
<b class="fc">&nbsp;                FailureException(ResponseEnum.CAR_MODEL_NOT_FOUND, &quot;Car model with ID $id not found&quot;)</b>
&nbsp;            }
&nbsp;    }
&nbsp;
&nbsp;    override fun getCarFeaturesByCarModelId(carModelId: Long): List&lt;CarFeatureResDTO&gt; {
<b class="fc">&nbsp;        return getActualCarModelById(carModelId).features.map { it.toResDTO() }</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun createCarModel(@Valid model: CarModelReqDTO): CarModelResDTO {
&nbsp;        try {
&nbsp;            // Retrieve car features info
<b class="fc">&nbsp;            val features: List&lt;CarFeature&gt; = carFeatureRepository.findAllById(model.featureIds)</b>
<b class="fc">&nbsp;            if (features.size != model.featureIds.size) {</b>
<b class="fc">&nbsp;                throw NoSuchElementException(&quot;One or more features ids are invalid&quot;)</b>
&nbsp;            }
&nbsp;            // Create model to persist and reference the list of features
<b class="fc">&nbsp;            val newModel = model.toEntity(features.toMutableSet())</b>
<b class="fc">&nbsp;            return carModelRepository.save(newModel).toResDTO()</b>
&nbsp;        } catch (e: Exception) {
<b class="fc">&nbsp;            throw FailureException(ResponseEnum.CAR_MODEL_DUPLICATED)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    override fun updateCarModel(id: Long, @Valid model: CarModelReqDTO): CarModelResDTO {
&nbsp;        // Check if car model exists
<b class="fc">&nbsp;        val modelToUpdate = getActualCarModelById(id)</b>
&nbsp;        // Retrieve car features info
<b class="fc">&nbsp;        val features: List&lt;CarFeature&gt; = carFeatureRepository.findAllById(model.featureIds)</b>
&nbsp;        // Check that all the ids correspond to a valid feature
<b class="pc">&nbsp;        if (features.size != model.featureIds.size) {</b>
<b class="nc">&nbsp;            throw NoSuchElementException(&quot;One or more features ids are invalid&quot;)</b>
&nbsp;        }
&nbsp;        // Update the fields
<b class="fc">&nbsp;        modelToUpdate.brand = model.brand</b>
<b class="fc">&nbsp;        modelToUpdate.model = model.model</b>
<b class="fc">&nbsp;        modelToUpdate.year = model.year</b>
<b class="fc">&nbsp;        modelToUpdate.segment = model.segment</b>
<b class="fc">&nbsp;        modelToUpdate.doorsNumber = model.doorsNumber</b>
<b class="fc">&nbsp;        modelToUpdate.seatingCapacity = model.seatingCapacity</b>
<b class="fc">&nbsp;        modelToUpdate.luggageCapacity = model.luggageCapacity</b>
<b class="fc">&nbsp;        modelToUpdate.category = model.category</b>
<b class="fc">&nbsp;        modelToUpdate.features = features.toMutableSet()</b>
<b class="fc">&nbsp;        modelToUpdate.engineType = model.engineType</b>
<b class="fc">&nbsp;        modelToUpdate.transmissionType = model.transmissionType</b>
<b class="fc">&nbsp;        modelToUpdate.drivetrain = model.drivetrain</b>
<b class="fc">&nbsp;        modelToUpdate.motorDisplacement = model.motorDisplacement</b>
<b class="fc">&nbsp;        modelToUpdate.rentalPrice = model.rentalPrice</b>
<b class="fc">&nbsp;        return modelToUpdate.toResDTO()</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun deleteCarModelById(id: Long) {
&nbsp;        // Check if car model exists
<b class="fc">&nbsp;        val modelToDelete = getActualCarModelById(id)</b>
&nbsp;        // Delete all the corresponding vehicles
<b class="fc">&nbsp;        vehicleService.deleteAllByCarModelId(id)</b>
&nbsp;        // Delete the car model
<b class="fc">&nbsp;        carModelRepository.delete(modelToDelete)</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun getActualCarModelById(id: Long): CarModel {
<b class="fc">&nbsp;        return carModelRepository.findById(id)</b>
<b class="fc">&nbsp;            .orElseThrow {</b>
<b class="fc">&nbsp;                FailureException(ResponseEnum.CAR_MODEL_NOT_FOUND, &quot;Car model with ID $id not found&quot;)</b>
&nbsp;            }
&nbsp;    }
&nbsp;
&nbsp;    /************************************************/
&nbsp;
&nbsp;    fun availabilityInDesiredDatesSpec(
&nbsp;        desiredStart: LocalDateTime,
&nbsp;        desiredEnd: LocalDateTime,
&nbsp;        reservationToUpdateId: Long?
&nbsp;    ): Specification&lt;CarModel&gt; {
<b class="nc">&nbsp;        return Specification { root, query, cb -&gt;</b>
&nbsp;            // Ensures that the result list has unique CarModels
<b class="nc">&nbsp;            query!!.distinct(true)</b>
&nbsp;            // Creates a subquery that returns a Long (the CarModel.id)
<b class="nc">&nbsp;            val subquery = query.subquery(Long::class.java)</b>
&nbsp;            // vehicleRoot is the root of this subquery — we’re querying the Vehicle table.
<b class="nc">&nbsp;            val vehicleRoot = subquery.from(Vehicle::class.java)</b>
&nbsp;            // Ensures the subquery&#39;s Vehicle.carModel matches the outer query’s CarModel (i.e., the one being tested).
<b class="nc">&nbsp;            val modelMatch = cb.equal(vehicleRoot.get&lt;CarModel&gt;(&quot;carModel&quot;), root)</b>
&nbsp;            // Only considers vehicles that are not in maintenance.
<b class="nc">&nbsp;            val notInMaintenance = cb.notEqual(vehicleRoot.get&lt;CarStatus&gt;(&quot;status&quot;), CarStatus.IN_MAINTENANCE)</b>
&nbsp;            // Creates an inner subquery that returns the ids of all vehicles that have at least one overlapping reservation
<b class="nc">&nbsp;            val overlappingReservationsVehicles = subquery.subquery(Long::class.java)</b>
&nbsp;            // reservationRoot is the root of this subquery — we’re querying the Reservation table.
<b class="nc">&nbsp;            val reservationRoot = overlappingReservationsVehicles.from(Reservation::class.java)</b>
&nbsp;            // Ensures the inner subquery&#39;s Reservation.vehicle matches the subquery’s Vehicle (i.e., the one being tested).
<b class="nc">&nbsp;            val vehicleMatch = cb.equal(reservationRoot.get&lt;Vehicle&gt;(&quot;vehicle&quot;), vehicleRoot)</b>
&nbsp;            // Only considers reservations that overlap the desired date range.
<b class="nc">&nbsp;            val overlappingReservation = cb.and(</b>
<b class="nc">&nbsp;                cb.lessThan(</b>
<b class="nc">&nbsp;                    reservationRoot.get(&quot;plannedPickUpDate&quot;),</b>
<b class="nc">&nbsp;                    desiredEnd.plusDays(reservationBufferDays)</b>
&nbsp;                ),
<b class="nc">&nbsp;                cb.greaterThan(</b>
<b class="nc">&nbsp;                    reservationRoot.get(&quot;plannedDropOffDate&quot;),</b>
<b class="nc">&nbsp;                    desiredStart.minusDays(reservationBufferDays)</b>
&nbsp;                )
&nbsp;            )
&nbsp;            // Ensures that, if a reservation is given, the vehicle associated to such reservation won&#39;t be considered as overlapping with itself
<b class="nc">&nbsp;            val reservedVehicleExclusion = reservationToUpdateId?.let { reservationToUpdateId -&gt;</b>
<b class="nc">&nbsp;                cb.notEqual(reservationRoot.get&lt;Long&gt;(&quot;id&quot;), reservationToUpdateId)</b>
<b class="nc">&nbsp;            } ?: cb.notEqual(reservationRoot.get&lt;Long&gt;(&quot;id&quot;), 0)</b>
&nbsp;            // Assembles the inner subquery filters: Belongs to current Vehicle AND Is reserved during the desired time AND does not match with the given reservation
<b class="nc">&nbsp;            overlappingReservationsVehicles.where(cb.and(vehicleMatch, overlappingReservation, reservedVehicleExclusion))</b>
&nbsp;            // The inner subquery returns the ID of the Vehicle associated with each matching Reservation.
<b class="nc">&nbsp;            overlappingReservationsVehicles.select(reservationRoot.get&lt;Vehicle&gt;(&quot;vehicle&quot;).get(&quot;id&quot;))</b>
&nbsp;            // The final condition is: such a reservation exists for the given Vehicle. If this is NOT true, the subquery will include the Vehicle.
<b class="nc">&nbsp;            val hasNoOverlappingReservations = cb.not(cb.exists(overlappingReservationsVehicles))</b>
&nbsp;            // Assembles the subquery filters: Belongs to current CarModel AND Is not in maintenance AND Is not reserved during the desired time
<b class="nc">&nbsp;            subquery.where(cb.and(modelMatch, notInMaintenance, hasNoOverlappingReservations))</b>
&nbsp;            // The subquery returns the ID of the CarModel associated with each matching Vehicle.
<b class="nc">&nbsp;            subquery.select(vehicleRoot.get&lt;CarModel&gt;(&quot;carModel&quot;).get(&quot;id&quot;))</b>
&nbsp;            // The final condition is: such a vehicle exists for the given CarModel. If this is true, the outer query will include the CarModel in the result.
<b class="nc">&nbsp;            cb.exists(subquery)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun availabilityForUserScoreSpec(userScore: Double): Specification&lt;CarModel&gt; {
<b class="nc">&nbsp;        return Specification { root, _, cb -&gt;</b>
&nbsp;            // Find all CarCategories where the required threshold is less than or equal to the user&#39;s score
<b class="nc">&nbsp;            val rentableCategories = CarCategory.entries.filter { CarCategory.getValue(it)!! &lt;= userScore }</b>
&nbsp;            // Get a reference to the &#39;category&#39; column of the CarModel table
<b class="nc">&nbsp;            val categoryPath = root.get&lt;CarCategory&gt;(&quot;category&quot;)</b>
&nbsp;            // Create an &#39;IN&#39; clause (WHERE category IN (...))
<b class="nc">&nbsp;            val inClause = cb.`in`(categoryPath)</b>
&nbsp;            // For each rentable category, add it to the &#39;IN&#39; clause
<b class="nc">&nbsp;            rentableCategories.forEach { inClause.value(it) }</b>
&nbsp;            // Return the final predicate that will be applied to the query
<b class="nc">&nbsp;            inClause</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-05-22 23:50</div>
</div>
</body>
</html>
